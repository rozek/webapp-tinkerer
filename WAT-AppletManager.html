<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>

  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="format-detection"       content="telephone=no">

  <title>WAT Developer</title>

  <style>
    html {
      text-size-adjust:100%;
      overflow:hidden scroll;
    }

    html, body {
      width:100vw; min-height:100vh;
      margin:0px; padding:0px;

      background-color: white;
      background-image: url(/common/BinaryTexture_white.jpg);
      background-repeat:repeat;

      font-family:'Source Sans Pro','Helvetica Neue',Helvetica,Arial,sans-serif;
      font-size:14px; font-weight:400; color:black;
      line-height:150%;
    }

    * {
      box-sizing:border-box;
    }
  </style>

  <script async src="https://rozek.github.io/es-module-shims/dist/es-module-shims.js"></script>
  <script type="importmap">
  {
    "imports": {
      "javascript-interface-library": "https://rozek.github.io/javascript-interface-library/dist/javascript-interface-library.esm.js",
      "JIL":                          "https://rozek.github.io/javascript-interface-library/dist/javascript-interface-library.esm.js",

      "svelte-coordinate-conversion":"https://rozek.github.io/svelte-coordinate-conversion/dist/svelte-coordinate-conversion.esm.js",

      "preact":     "https://rozek.github.io/htm/preact/standalone.module.js",
      "htm/preact": "https://rozek.github.io/htm/preact/standalone.module.js",
      "preact-with-htm":"https://rozek.github.io/htm/preact/standalone.module.js",

      "hyperactiv":      "https://rozek.github.io/hyperactiv/dist/hyperactiv.esm.js",
      "rozek/hyperactiv":"https://rozek.github.io/hyperactiv/dist/hyperactiv.esm.js",

      "nanoid":           "https://rozek.github.io/nanoid/dist/nanoid.esm.js",
      "nanoid-dictionary":"https://rozek.github.io/nanoid-dictionary/dist/nanoid-dictionary.esm.js",

      "WAT-Runtime": "https://rozek.github.io/webapp-tinkerer/js/WAT-Runtime.esm.js",
      "WAT-Designer":"https://rozek.github.io/webapp-tinkerer/js/WAT-Designer.esm.js"
    }
  }
  </script>

  <script src="/js/localforage.min.js"></script>

  <script type="wat/applet">
{"Name":"WAT-Applet","FontSize":14,"FontWeight":"normal","FontStyle":"normal","TextShadow":{"isActive":false,"xOffset":0,"yOffset":0,"BlurRadius":5,"Color":"#ff0000"},"TextAlignment":"left","ForegroundColor":"#000000","hasBackground":true,"BackgroundColor":"#ffffff","BackgroundTexture":{"isActive":true,"ImageURL":"/common/BinaryTexture_white.jpg","Mode":"tile","xOffset":0,"yOffset":0},"Opacity":100,"activeScript":"const Applet = me\n  localforage.config({\n    driver: [localforage.INDEXEDDB, localforage.WEBSQL]\n  })\n\n  let AppletStore\n\n  let persistedAppletList  = []\n  let normalizedAppletList = []\n\n  let selectedApplet      = undefined\n  let selectedAppletIndex = -1\n\n  let fullScreenWanted = false\n\n  localforage.ready(async function () {\n    AppletStore = localforage.createInstance({\n      name:'WebApp Tinkerer'\n    })\n\n  onMount(async () => {\n    Applet.closeDialog('AppletBrowser')       // useful when script is refreshed\n\n    const {\n      AppletListView,\n      OpenAppletButton, PurgeAppletButton,\n      AppletNameInput,\n      AppletFullscreenChoice, AppletSizeChoice,\n      AppletWidthInput, AppletHeightInput,\n      CreateAppletButton, UpdateAppletButton,\n    } = Applet.namedWidgets\n\n/**** Input Handling ****/\n\n  AppletListView.onSelectionChange(async (selectedIndices) => {\n    const SelectionIndex = selectedIndices[0]\n    if (SelectionIndex != null) {\n      let AppletName = persistedAppletList[SelectionIndex]\n      selectedApplet = await persistedApplet(AppletName)\n    }\n    await updateSelection()\n    updateEnabling()\n    Applet.rerender()\n  })\n\n  OpenAppletButton.onClick(() => {\n    openApplet(\n      selectedApplet, fullScreenWanted,\n      AppletWidthInput.Value, AppletHeightInput.Value\n    )\n  })\n\n  PurgeAppletButton.onClick(async () => {\n    if (OperationWasConfirmed(\n      `Do you really want to permanently delete applet \"${selectedApplet.Name}\"?`\n    )) {\n      await purgeApplet(selectedApplet)\n      await scanPersistedApplets()\n\n      selectedApplet = undefined\n      await updateSelection()\n\n      updateEnabling()\n      Applet.rerender()\n    }\n  })\n\n  AppletNameInput.onInput(updateEnabling)\n\n  AppletFullscreenChoice.onClick(() => {\n    fullScreenWanted = true\n    AppletSizeChoice.Value = false\n    updateEnabling()\n    Applet.rerender()\n  })\n  AppletSizeChoice.onClick(() => {\n    fullScreenWanted = false\n    AppletFullscreenChoice.Value = false\n    updateEnabling()\n    Applet.rerender()\n  })\n\n  AppletWidthInput.onInput(updateEnabling)\n  AppletHeightInput.onInput(updateEnabling)\n\n  CreateAppletButton.onClick(async () => {\n    selectedApplet = await newApplet(\n      AppletNameInput.Value, fullScreenWanted,\n      AppletWidthInput.Value, AppletHeightInput.Value\n    )\n    await scanPersistedApplets()\n    await updateSelection()\n\n    updateEnabling()\n    Applet.rerender()\n  })\n\n  UpdateAppletButton.onClick(async () => {\n    await updateApplet(\n      selectedApplet,\n      AppletNameInput.Value, fullScreenWanted,\n      AppletWidthInput.Value, AppletHeightInput.Value\n    )\n    await scanPersistedApplets()\n    await updateSelection()\n\n    updateEnabling()\n    Applet.rerender()\n  })\n\n/**** updateEnabling ****/\n\n  function updateEnabling () {\n    OpenAppletButton.Enabling   = (selectedAppletIndex >= 0)\n    PurgeAppletButton.Enabling  = (selectedAppletIndex >= 0)\n\n    CreateAppletButton.Enabling = (\n      ValueIsName(AppletNameInput.Value) && NameIsNew(AppletNameInput.Value)\n    )\n\n    UpdateAppletButton.Enabling = (\n      (selectedApplet != null) && (\n        (selectedApplet.Name !== AppletNameInput.Value) &&\n          ValueIsName(AppletNameInput.Value) && NameIsNew(AppletNameInput.Value) ||\n        (selectedApplet.Name === AppletNameInput.Value) && (\n          (fullScreenWanted        !== selectedApplet._fullScreen) ||\n          (AppletWidthInput.Value  !== selectedApplet._Width) ||\n          (AppletHeightInput.Value !== selectedApplet._Height)\n        )\n      )\n    )\n  }\n\n/**** NameIsNew ****/\n\n  function NameIsNew (Name) {\n    return (normalizedAppletList.indexOf(Name.toLowerCase()) < 0)\n  }\n\n/**** scanPersistedApplets ****/\n\n  async function scanPersistedApplets () {\n    try {\n      persistedAppletList = (await AppletStore.keys()).sort()\n    } catch (Signal) {\n      persistedAppletList = []\n      console.warn('could not fetch names of persisted applet',Signal)\n    }\n\n    normalizedAppletList = persistedAppletList.map(\n      (Name) => Name.toLowerCase()\n    )\n\n    AppletListView.List = persistedAppletList\n  }                                 // should be followed by \"updateSelection()\"\n\n/**** updateSelection ****/\n\n  async function updateSelection () {\n    if (selectedApplet != null) {\n      selectedAppletIndex = normalizedAppletList.indexOf(\n        selectedApplet.Name.toLowerCase()\n      )\n      if (selectedAppletIndex >= 0) {\n        selectedApplet = await persistedApplet(selectedApplet.Name)\n          AppletNameInput.Value        = selectedApplet.Name\n          AppletFullscreenChoice.Value = selectedApplet.fullScreen\n          AppletSizeChoice.Value       = ! selectedApplet.fullScreen\n\n          const { Width,Height } = selectedApplet\n          AppletWidthInput.Value       = (ValueIsCardinal(Width)  ? Width  : 640)\n          AppletHeightInput.Value      = (ValueIsCardinal(Height) ? Height : 480)\n        AppletListView.selectedIndices = [selectedAppletIndex]\n        return\n      }         // the already known applet could have changed in the background\n    }\n\n    selectedApplet      = undefined\n    selectedAppletIndex = -1\n\n    AppletListView.selectedIndices = []\n  }\n\n/**** persistedApplet ****/\n\n  async function persistedApplet (Name) {\n    try {\n      return JSON.parse(await AppletStore.getItem(Name))\n    } catch (Signal) {\n      throw new Error(\n        `PersistenceReadError: could not read applet \"${Name}\", ` +\n        'reason: ' + Signal\n      )\n    }\n  }\n\n/**** openApplet ****/\n\n  async function openApplet (Applet, fullScreenWanted, Width,Height) {\n    const URLPrefix = `WAT-Developer.html?name=${encodeURIComponent(Applet.Name)}&`\n\n    if (fullScreenWanted) {\n      window.open(URLPrefix + 'fullscreen=true','_self')\n    } else {\n      window.open(URLPrefix + `width=${Width}&height=${Height}`,'_self')\n    }\n  }\n\n/**** purgeApplet ****/\n\n  async function purgeApplet (Applet) {\n    try {\n      await AppletStore.removeItem(Applet.Name)\n    } catch (Signal) {\n      throw new Error(\n        `PersistenceWriteError: could not delete project \"${Applet.Name}\", ` +\n        'reason: ' + Signal\n      )\n    }\n  }\n\n/**** newApplet ****/\n\n  async function newApplet (Name, fullScreen, Width,Height) {\n    const Serialization = {\n      Name, fullScreen, Width,Height,\n      PageList:[{ WidgetList:[] }]\n    }\n\n    try {\n      await AppletStore.setItem(Name,JSON.stringify(Serialization))\n    } catch (Signal) {\n      throw new Error(\n        `PersistenceWriteError: could not write applet \"${Name}\", ` +\n        'reason: ' + Signal\n      )\n    }\n\n    return Serialization\n  }\n\n/**** updateApplet (includes renaming) ****/\n\n  async function updateApplet (Applet, Name, fullScreen, Width,Height) {\n    const oldName = Applet.Name\n\n    Object.assign(Applet, { Name, fullScreen, Width,Height })\n\n    try {\n      await AppletStore.setItem(Name,JSON.stringify(Applet))\n    } catch (Signal) {\n      throw new Error(\n        `PersistenceWriteError: could not write applet \"${Name}\", ` +\n        'reason: ' + Signal\n      )\n    }\n\n    if (Name !== oldName) {\n      try {\n        await AppletStore.removeItem(oldName)\n      } catch (Signal) {\n        throw new Error(\n          `PersistenceWriteError: could not delete applet \"${Name}\", ` +\n          'reason: ' + Signal\n        )\n      }\n    }\n  }\n\n/**** OperationWasConfirmed ****/\n\n  function OperationWasConfirmed (Message) {\n    let ConfirmationCode = Math.round(Math.random()*10000).toString()\n      ConfirmationCode += '0000'.slice(ConfirmationCode.length)\n\n    Message = (Message || 'This operation can not be undone.') + '\\n\\n' +\n      'Please, enter the following number if you want to proceed:\\n\\n' +\n      '   ' + ConfirmationCode + '\\n\\n' +\n      'Otherwise, the operation will be cancelled'\n\n    let UserInput = window.prompt(Message,'')\n    if (UserInput === ConfirmationCode) {\n      return true\n    } else {\n      window.alert('Operation will be cancelled')\n      return false\n    }\n  }\n\n/**** ValueIsName ****/\n\n  const WAT_NamePattern = /^[^\\x00-\\x1F\\x7F /#][^\\x00-\\x1F\\x7F/]*$/\n                                // no ctrl.char.s, no \"/\", no leading \" \" or \"#\"\n\n  function ValueIsName (Value) {\n    return (\n      (typeof Value === 'string') && WAT_NamePattern.test(Value) &&\n      (Value.trim() === Value) &&\n      (Value.trim() !== '.') && (Value.trim() !== '..')\n    )\n  }/**** ValueIsCardinal ****/\n\n  function ValueIsCardinal (Value) {\n    return (\n      (typeof Value === 'number') &&\n      (Math.floor(Value) === Value) &&\n      (Value >= 1)\n    )\n  }\n\n    await scanPersistedApplets()\n    await updateSelection()\n    updateEnabling()\n\n    Applet.openDialog({\n      Name: 'AppletBrowser',\n      Title:'Applet Browser',\n      isClosable: true,\n      isDraggable:true,\n      isResizable:true,\n      Width: 240, minWidth: 240,\n      Height:320, minHeight:320,\n      SourceWidget:'Applet Browser/Dialog Contents'\n    })\n  })\n})","SnapToGrid":true,"GridWidth":10,"GridHeight":10,"Width":800,"Height":600,"PageList":[{"Name":"HomePage","hasBackground":false,"BackgroundColor":"#ff0000"},{"Name":"Applet Browser","hasBackground":false,"WidgetList":[{"Name":"AppletListView","hasBackground":false,"Type":"FlatListView","Anchors":["left-right","top-bottom"],"Offsets":[40,540,60,480],"Placeholder":"(no Applets yet)","SelectionLimit":1},{"Name":"UpdateAppletButton","hasBackground":false,"memoized":{},"Value":"Update","Type":"Button","Enabling":false,"Anchors":["width-right","height-bottom"],"Offsets":[80,540,30,260]},{"Name":"CreateAppletButton","hasBackground":false,"memoized":{},"Value":"Create","Type":"Button","Anchors":["left-width","height-bottom"],"Offsets":[40,80,30,260]},{"hasBackground":false,"Value":"px","Type":"Label","Anchors":["left-width","height-bottom"],"Offsets":[220,20,30,300]},{"Name":"AppletHeightInput","hasBackground":false,"Value":480,"Type":"NumberInput","Anchors":["left-width","height-bottom"],"Offsets":[150,60,30,300],"readonly":false},{"TextAlignment":"center","hasBackground":false,"Value":"x","Type":"Label","Anchors":["left-width","height-bottom"],"Offsets":[130,20,30,300]},{"Name":"AppletWidthInput","hasBackground":false,"Value":640,"Type":"NumberInput","Anchors":["left-width","height-bottom"],"Offsets":[70,60,30,300],"readonly":false},{"hasBackground":false,"Value":"fullscreen","Type":"Label","Anchors":["left-width","height-bottom"],"Offsets":[70,130,30,330]},{"Name":"AppletSizeChoice","hasBackground":false,"Type":"Radiobutton","Anchors":["left-width","height-bottom"],"Offsets":[40,20,30,300]},{"Name":"AppletFullscreenChoice","hasBackground":false,"Type":"Radiobutton","Anchors":["left-width","height-bottom"],"Offsets":[40,20,30,330]},{"Name":"AppletNameInput","hasBackground":false,"Value":"Test","Type":"TextlineInput","Anchors":["left-right","height-bottom"],"Offsets":[40,540,30,370],"readonly":false,"SpellChecking":false},{"hasBackground":false,"Value":"Applet Name","Type":"Label","Anchors":["left-width","height-bottom"],"Offsets":[40,130,30,400]},{"Name":"PurgeAppletButton","hasBackground":false,"memoized":{},"Value":"Purge","Type":"Button","Enabling":false,"Anchors":["width-right","height-bottom"],"Offsets":[80,540,30,440]},{"Name":"OpenAppletButton","hasBackground":false,"memoized":{},"Value":"Open","Type":"Button","Enabling":false,"Anchors":["left-width","height-bottom"],"Offsets":[40,80,30,440]},{"hasBackground":false,"Value":"Recent Applets","Type":"Label","Offsets":[40,130,30,30]},{"Name":"Dialog Contents","hasBackground":false,"Type":"Outline","Anchors":["left-right","top-bottom"],"Offsets":[30,530,30,250]}]}]}
  </script>

  <script type="module" src="/js/WAT-Runtime.esm.js"></script>
  <!--script type="module" src="/js/WAT-Designer.esm.js"></script-->
 </head>
 <body>
  <div type="wat/applet" name="WAT-AppletManager" style="
    display:block; position:absolute;
    width:800px; height:600px; margin:auto;
  "></div>
 </body>
</html>
