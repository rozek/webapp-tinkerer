<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8">

  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>

  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="format-detection"       content="telephone=no">

  <title>WAT Developer</title>

  <style>
    html {
      text-size-adjust:100%;
      overflow:hidden scroll;
    }

    html, body {
      width:100vw; min-height:100vh;
      margin:0px; padding:0px;

      background-color: #627AC6;
      background-image: url(../common/BinaryTexture_blue.jpg);
      background-repeat:repeat;

      font-family:'Source Sans Pro','Helvetica Neue',Helvetica,Arial,sans-serif;
      font-size:14px; font-weight:400; color:black;
      line-height:150%;
    }

    * {
      box-sizing:border-box;
    }
  </style>

  <script async src="https://rozek.github.io/es-module-shims/dist/es-module-shims.js"></script>
  <script type="importmap">
  {
    "imports": {
      "javascript-interface-library": "https://rozek.github.io/javascript-interface-library/dist/javascript-interface-library.esm.js",
      "JIL":                          "https://rozek.github.io/javascript-interface-library/dist/javascript-interface-library.esm.js",

      "svelte-coordinate-conversion":"https://rozek.github.io/svelte-coordinate-conversion/dist/svelte-coordinate-conversion.esm.js",
      "svelte-touch-to-mouse":       "https://rozek.github.io/svelte-touch-to-mouse/dist/svelte-touch-to-mouse.esm.js",

      "preact":     "https://rozek.github.io/htm/preact/standalone.module.js",
      "htm/preact": "https://rozek.github.io/htm/preact/standalone.module.js",
      "preact-with-htm":"https://rozek.github.io/htm/preact/standalone.module.js",

      "hyperactiv":      "https://rozek.github.io/hyperactiv/dist/index.mjs",
      "rozek/hyperactiv":"https://rozek.github.io/hyperactiv/dist/index.mjs",

      "nanoid":           "https://rozek.github.io/nanoid/dist/nanoid.esm.js",
      "nanoid-dictionary":"https://rozek.github.io/nanoid-dictionary/dist/nanoid-dictionary.esm.js",

      "WAT-Runtime": "https://rozek.github.io/webapp-tinkerer/js/WAT-Runtime.esm.js",
      "WAT-Designer":"https://rozek.github.io/webapp-tinkerer/js/WAT-Designer.esm.js",

      "marked":                "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js",
      "marked-katex-extension":"https://cdn.jsdelivr.net/npm/marked-katex-extension/+esm",
      "marked-highlight":      "https://cdn.jsdelivr.net/npm/marked-highlight/+esm",
      "highlight.js/lib/core":                "https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/es/highlight.min.js",
      "highlight.js/lib/languages/css":       "https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/es/languages/css.min.js",
      "highlight.js/lib/languages/javascript":"https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/es/languages/javascript.min.js",
      "highlight.js/lib/languages/java":      "https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/es/languages/java.min.js",
      "highlight.js/lib/languages/json":      "https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/es/languages/json.min.js",
      "highlight.js/lib/languages/typescript":"https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/es/languages/typescript.min.js",
      "highlight.js/lib/languages/xml":       "https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/es/languages/xml.min.js",

      "katex": "https://cdn.jsdelivr.net/npm/katex/+esm"
    }
  }
  </script>


  <script src="https://rozek.github.io/localForage/dist/localforage.min.js"></script>

  <script type="wat/applet">
{"Name":"WAT-Applet","FontSize":14,"FontWeight":"normal","FontStyle":"normal","TextShadow":{"isActive":false,"xOffset":0,"yOffset":0,"BlurRadius":5,"Color":"#ff0000"},"TextAlignment":"left","ForegroundColor":"#000000","hasBackground":true,"BackgroundColor":"#ffffff","BackgroundTexture":{"isActive":true,"ImageURL":"https://rozek.github.io/webapp-tinkerer/common/BinaryTexture_blue.jpg","Mode":"tile","xOffset":0,"yOffset":0},"Opacity":100,"activeScript":"const Applet = me\n  localforage.config({\n    driver: [localforage.INDEXEDDB, localforage.WEBSQL]\n  })\n\n  let AppletStore\n\n  let persistedAppletList  = []\n  let normalizedAppletList = []\n\n  let selectedApplet      = undefined\n  let selectedAppletIndex = -1\n\n  localforage.ready(async function () {\n    AppletStore = localforage.createInstance({\n      name:'WebApp Tinkerer'\n    })\n\n  onMount(async () => {\n    Applet.closeDialog('AppletBrowser')       // useful when script is refreshed\n\n    const {\n      AppletListView,\n      OpenAppletButton, PurgeAppletButton,\n      NameInput,\n      minWidthInput, minHeightInput,\n      maxWidthInput, maxHeightInput,\n      CenterCheck, MobileFrameCheck, OrientationChoice,\n      CreateAppletButton, UpdateAppletButton,\n    } = Applet.namedWidgets\n\n/**** Input Handling ****/\n\n  AppletListView.onSelectionChange(async (selectedIndices) => {\n    const SelectionIndex = selectedIndices[0]\n    if (SelectionIndex != null) {\n      let AppletName = persistedAppletList[SelectionIndex]\n      selectedApplet = await persistedApplet(AppletName)\n    }\n    await updateSelection()\n    updateEnabling()\n    Applet.rerender()\n  })\n\n  OpenAppletButton.onClick(() => {\n    openApplet(\n      selectedApplet,\n      minWidthInput.Value, minHeightInput.Value,\n      maxWidthInput.Value, maxHeightInput.Value,\n      CenterCheck.Value, MobileFrameCheck.Value, OrientationChoice.Value\n    )\n  })\n\n  PurgeAppletButton.onClick(async () => {\n    if (OperationWasConfirmed(\n      `Do you really want to permanently delete applet \"${selectedApplet.Name}\"?`\n    )) {\n      await purgeApplet(selectedApplet)\n      await scanPersistedApplets()\n\n      selectedApplet = undefined\n      await updateSelection()\n\n      updateEnabling()\n      Applet.rerender()\n    }\n  })\n\n  NameInput.onInput(updateEnabling)\n\n  minWidthInput.onInput(updateEnabling)\n  minHeightInput.onInput(updateEnabling)\n\n  maxWidthInput.onInput(updateEnabling)\n  maxHeightInput.onInput(updateEnabling)\n\n  CenterCheck.onClick(updateEnabling)\n  MobileFrameCheck.onClick(updateEnabling)\n\n  OrientationChoice.onInput(updateEnabling)\n\n  CreateAppletButton.onClick(async () => {\n    selectedApplet = await newApplet(\n      NameInput.Value,\n      minWidthInput.Value, minHeightInput.Value,\n      maxWidthInput.Value, maxHeightInput.Value,\n      CenterCheck.Value, MobileFrameCheck.Value, OrientationChoice.Value\n    )\n    await scanPersistedApplets()\n    await updateSelection()\n\n    updateEnabling()\n    Applet.rerender()\n  })\n\n  UpdateAppletButton.onClick(async () => {\n    await updateApplet(\n      selectedApplet,\n      NameInput.Value,\n      minWidthInput.Value, minHeightInput.Value,\n      maxWidthInput.Value, maxHeightInput.Value,\n      CenterCheck.Value\n    )\n    await scanPersistedApplets()\n    await updateSelection()\n\n    updateEnabling()\n    Applet.rerender()\n  })\n\n/**** updateEnabling ****/\n\n  function updateEnabling () {\n    OpenAppletButton.Enabling   = (selectedAppletIndex >= 0)\n    PurgeAppletButton.Enabling  = (selectedAppletIndex >= 0)\n\n    CreateAppletButton.Enabling = (\n      ValueIsName(NameInput.Value) && NameIsNew(NameInput.Value)\n    )\n\n    UpdateAppletButton.Enabling = (\n      (selectedApplet != null) && (\n        (selectedApplet.Name !== NameInput.Value) &&\n          ValueIsName(NameInput.Value) && NameIsNew(NameInput.Value) ||\n        (selectedApplet.Name === NameInput.Value) && (\n          (minWidthInput.Value  !== selectedApplet.minWidth)  ||\n          (minHeightInput.Value !== selectedApplet.minHeight) ||\n          (maxWidthInput.Value  !== selectedApplet.maxWidth)  ||\n          (maxHeightInput.Value !== selectedApplet.maxHeight) ||\n          (CenterCheck.Value       !== selectedApplet.toBeCentered) ||\n          (MobileFrameCheck.Value  !== selectedApplet.withMobileFrame) ||\n          (OrientationChoice.Value !== selectedApplet.expectedOrientation)\n        )\n      )\n    )\n  }\n\n/**** NameIsNew ****/\n\n  function NameIsNew (Name) {\n    return (normalizedAppletList.indexOf(Name.toLowerCase()) < 0)\n  }\n\n/**** scanPersistedApplets ****/\n\n  async function scanPersistedApplets () {\n    try {\n      persistedAppletList = (await AppletStore.keys()).sort()\n    } catch (Signal) {\n      persistedAppletList = []\n      console.warn('could not fetch names of persisted applet',Signal)\n    }\n\n    normalizedAppletList = persistedAppletList.map(\n      (Name) => Name.toLowerCase()\n    )\n\n    AppletListView.List = persistedAppletList\n  }                                 // should be followed by \"updateSelection()\"\n\n/**** updateSelection ****/\n\n  async function updateSelection () {\n    if (selectedApplet != null) {\n      selectedAppletIndex = normalizedAppletList.indexOf(\n        selectedApplet.Name.toLowerCase()\n      )\n      if (selectedAppletIndex >= 0) {\n        selectedApplet = await persistedApplet(selectedApplet.Name)\n          NameInput.Value        = selectedApplet.Name\n\n          const { minWidth,minHeight } = selectedApplet\n          minWidthInput.Value       = (ValueIsOrdinal(minWidth)  ? minWidth  : 0)\n          minHeightInput.Value      = (ValueIsOrdinal(minHeight) ? minHeight : 0)\n\n          const { maxWidth,maxHeight } = selectedApplet\n          maxWidthInput.Value       = (ValueIsOrdinal(maxWidth)  ? maxWidth  : undefined)\n          maxHeightInput.Value      = (ValueIsOrdinal(maxHeight) ? maxHeight : undefined)\n\n          CenterCheck.Value      = selectedApplet.toBeCentered\n          MobileFrameCheck.Value = selectedApplet.withMobileFrame\n\n          OrientationChoice.Value = selectedApplet.expectedOrientation || 'any'\n        AppletListView.selectedIndices = [selectedAppletIndex]\n        return\n      }         // the already known applet could have changed in the background\n    }\n\n    selectedApplet      = undefined\n    selectedAppletIndex = -1\n\n    AppletListView.selectedIndices = []\n  }\n\n/**** persistedApplet ****/\n\n  async function persistedApplet (Name) {\n    try {\n      return JSON.parse(await AppletStore.getItem(Name))\n    } catch (Signal) {\n      throw new Error(\n        `PersistenceReadError: could not read applet \"${Name}\", ` +\n        'reason: ' + Signal\n      )\n    }\n  }\n\n/**** openApplet ****/\n\n  async function openApplet (\n    Applet, minWidth,minHeight, maxWidth,maxHeight, toBeCentered,\n    withMobileFrame, expectedOrientation\n  ) {\n    const URL = (\n      `WAT-Developer.html?name=${encodeURIComponent(Applet.Name)}&` +\n      (minWidth  > 0 ? `min-width=${minWidth}&`   : '') +\n      (minHeight > 0 ? `min-height=${minHeight}&` : '') +\n      (maxWidth  > 0 ? `max-width=${maxWidth}&`   : '') +\n      (maxHeight > 0 ? `max-height=${maxHeight}&` : '') +\n      `with-mobile-frame=${withMobileFrame ? 'true' : 'false'}` +\n      `expected-orientation=${expectedOrientation}` +\n      'center=false&offset=true'               // particularly for the developer\n    )\n    window.open(URL,'_self')\n  }\n\n/**** purgeApplet ****/\n\n  async function purgeApplet (Applet) {\n    try {\n      await AppletStore.removeItem(Applet.Name)\n    } catch (Signal) {\n      throw new Error(\n        `PersistenceWriteError: could not delete project \"${Applet.Name}\", ` +\n        'reason: ' + Signal\n      )\n    }\n  }\n\n/**** newApplet ****/\n\n  async function newApplet (\n    Name, minWidth,minHeight, maxWidth,maxHeight, toBeCentered,\n    withMobileFrame, expectedOrientation\n  ) {\n    const Serialization = {\n      Name, minWidth,minHeight, maxWidth,maxHeight, toBeCentered,\n      withMobileFrame, expectedOrientation,\n      PageList:[{ WidgetList:[] }]\n    }\n\n    try {\n      await AppletStore.setItem(Name,JSON.stringify(Serialization))\n    } catch (Signal) {\n      throw new Error(\n        `PersistenceWriteError: could not write applet \"${Name}\", ` +\n        'reason: ' + Signal\n      )\n    }\n\n    return Serialization\n  }\n\n/**** updateApplet (includes renaming) ****/\n\n  async function updateApplet (\n    Applet, Name, minWidth,minHeight, maxWidth,maxHeight, toBeCentered,\n    withMobileFrame=false, expectedOrientation='any'\n  ) {\n    const oldName = Applet.Name\n\n    Object.assign(Applet, {\n      Name, minWidth,minHeight, maxWidth,maxHeight, toBeCentered,\n      withMobileFrame, expectedOrientation\n    })\n\n    try {\n      await AppletStore.setItem(Name,JSON.stringify(Applet))\n    } catch (Signal) {\n      throw new Error(\n        `PersistenceWriteError: could not write applet \"${Name}\", ` +\n        'reason: ' + Signal\n      )\n    }\n\n    if (Name !== oldName) {\n      try {\n        await AppletStore.removeItem(oldName)\n      } catch (Signal) {\n        throw new Error(\n          `PersistenceWriteError: could not delete applet \"${Name}\", ` +\n          'reason: ' + Signal\n        )\n      }\n    }\n  }\n\n/**** OperationWasConfirmed ****/\n\n  function OperationWasConfirmed (Message) {\n    let ConfirmationCode = Math.round(Math.random()*10000).toString()\n      ConfirmationCode += '0000'.slice(ConfirmationCode.length)\n\n    Message = (Message || 'This operation can not be undone.') + '\\n\\n' +\n      'Please, enter the following number if you want to proceed:\\n\\n' +\n      '   ' + ConfirmationCode + '\\n\\n' +\n      'Otherwise, the operation will be cancelled'\n\n    let UserInput = window.prompt(Message,'')\n    if (UserInput === ConfirmationCode) {\n      return true\n    } else {\n      window.alert('Operation will be cancelled')\n      return false\n    }\n  }\n\n/**** ValueIsName ****/\n\n  const WAT_NamePattern = /^[^\\x00-\\x1F\\x7F /#][^\\x00-\\x1F\\x7F/]*$/\n                                // no ctrl.char.s, no \"/\", no leading \" \" or \"#\"\n\n  function ValueIsName (Value) {\n    return (\n      (typeof Value === 'string') && WAT_NamePattern.test(Value) &&\n      (Value.trim() === Value) &&\n      (Value.trim() !== '.') && (Value.trim() !== '..')\n    )\n  }/**** ValueIsOrdinal ****/\n\n  function ValueIsOrdinal (Value) {\n    return (\n      (typeof Value === 'number') &&\n      (Math.floor(Value) === Value) &&\n      (Value >= 0)\n    )\n  }\n\n\n\n    await scanPersistedApplets()\n    await updateSelection()\n    updateEnabling()\n\n    Applet.openDialog({\n      Name: 'AppletBrowser',\n      Title:'Applet Browser',\n      isClosable: true,\n      isDraggable:true,\n      isResizable:true,\n      Width: 320, minWidth: 320,\n      Height:440, minHeight:440,\n      SourceWidget:'Applet Browser/Dialog Contents'\n    })\n  })\n})","SnapToGrid":true,"GridWidth":10,"GridHeight":10,"Width":800,"Height":600,"PageList":[{"Name":"HomePage","hasBackground":false,"BackgroundColor":"#ff0000"},{"Name":"Applet Browser","hasBackground":true,"BackgroundTexture":{"isActive":true,"ImageURL":"https://rozek.github.io/webapp-tinkerer/common/BinaryTexture_white.jpg","Mode":"tile","xOffset":0,"yOffset":0},"WidgetList":[{"Name":"OrientationChoice","hasBackground":false,"Type":"DropDown","Anchors":["left-width","height-bottom"],"Offsets":[190,120,30,180],"Options":["any","portrait","landscape"]},{"hasBackground":false,"Value":"mobile Orientations:","Type":"Label","Anchors":["left-width","height-bottom"],"Offsets":[40,140,30,180]},{"Name":"MobileFrameCheck","hasBackground":false,"Value":true,"Type":"Checkbox","Anchors":["left-width","height-bottom"],"Offsets":[40,20,30,210]},{"hasBackground":false,"Value":"with \"mobile Frame\"","Type":"Label","Anchors":["left-width","height-bottom"],"Offsets":[65,165,30,210]},{"Name":"CenterCheck","hasBackground":false,"Value":true,"Type":"Checkbox","Anchors":["left-width","height-bottom"],"Offsets":[40,20,30,240]},{"hasBackground":false,"Value":"px","Type":"Label","Anchors":["left-width","height-bottom"],"Offsets":[290,20,30,270]},{"Name":"maxHeightInput","hasBackground":false,"Value":480,"Type":"NumberInput","Anchors":["left-width","height-bottom"],"Offsets":[220,60,30,270],"Placeholder":"H","readonly":false},{"TextAlignment":"center","hasBackground":false,"Value":"x","Type":"Label","Anchors":["left-width","height-bottom"],"Offsets":[200,20,30,270]},{"Name":"maxWidthInput","hasBackground":false,"Value":640,"Type":"NumberInput","Anchors":["left-width","height-bottom"],"Offsets":[140,60,30,270],"Placeholder":"W","readonly":false},{"hasBackground":false,"Value":"maximal Size","Type":"Label","Anchors":["left-width","height-bottom"],"Offsets":[40,90,30,270]},{"hasBackground":false,"Value":"px","Type":"Label","Anchors":["left-width","height-bottom"],"Offsets":[290,20,30,300]},{"Name":"minHeightInput","hasBackground":false,"Value":480,"Type":"NumberInput","Anchors":["left-width","height-bottom"],"Offsets":[220,60,30,300],"Placeholder":"H","readonly":false},{"TextAlignment":"center","hasBackground":false,"Value":"x","Type":"Label","Anchors":["left-width","height-bottom"],"Offsets":[200,20,30,300]},{"Name":"minWidthInput","hasBackground":false,"Value":640,"Type":"NumberInput","Anchors":["left-width","height-bottom"],"Offsets":[140,60,30,300],"Placeholder":"W","readonly":false},{"hasBackground":false,"Value":"minimal Size","Type":"Label","Anchors":["left-width","height-bottom"],"Offsets":[40,90,30,300]},{"Name":"AppletListView","hasBackground":false,"Type":"FlatListView","Anchors":["left-right","top-bottom"],"Offsets":[40,460,60,450],"Placeholder":"(no Applets yet)","SelectionLimit":1},{"Name":"UpdateAppletButton","hasBackground":false,"memoized":{},"Value":"Update","Type":"Button","Enabling":false,"Anchors":["width-right","height-bottom"],"Offsets":[80,460,30,140]},{"Name":"CreateAppletButton","hasBackground":false,"memoized":{},"Value":"Create","Type":"Button","Anchors":["left-width","height-bottom"],"Offsets":[40,80,30,140]},{"hasBackground":false,"Value":"center in Viewport","Type":"Label","Anchors":["left-width","height-bottom"],"Offsets":[65,165,30,240]},{"Name":"NameInput","hasBackground":false,"Value":"Test","Type":"TextlineInput","Anchors":["left-right","height-bottom"],"Offsets":[40,460,30,340],"readonly":false,"SpellChecking":false},{"hasBackground":false,"Value":"Applet Name","Type":"Label","Anchors":["left-width","height-bottom"],"Offsets":[40,130,30,370]},{"Name":"PurgeAppletButton","hasBackground":false,"memoized":{},"Value":"Purge","Type":"Button","Enabling":false,"Anchors":["width-right","height-bottom"],"Offsets":[80,460,30,410]},{"Name":"OpenAppletButton","hasBackground":false,"memoized":{},"Value":"Open","Type":"Button","Enabling":false,"Anchors":["left-width","height-bottom"],"Offsets":[40,80,30,410]},{"hasBackground":false,"Value":"Recent Applets","Type":"Label","Offsets":[40,130,30,30]},{"Name":"Dialog Contents","hasBackground":false,"Type":"Outline","Anchors":["left-right","top-bottom"],"Offsets":[30,450,30,130]}]}]}
  </script>

  <script type="module" src="https://rozek.github.io/webapp-tinkerer/js/WAT-Runtime.esm.js"></script>
  <!--script type="module" src="https://rozek.github.io/webapp-tinkerer/js/WAT-Designer.esm.js"></script-->
 </head>
 <body>
  <div type="wat/applet" name="WAT-AppletManager"></div>
 </body>
</html>
